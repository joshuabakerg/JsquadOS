local tabs = {}
local tabsTerm = {}
local tabNames = {}
local currentTab = 1
local mainTerm = term.current()
local tEvn = {
    ["shell"] = shell,
    ["multishell"] = multishell,
}
local parentShell = shell
local termCoords = {}
defaultTermSize = {1,1,51,19}

function newTab(sProg,sName,sArgs)
	tabs[#tabs + 1] = coroutine.create(function()
		os.run(tEvn,"/bin/josShell",sProg,table.unpack({sargs}))
	end)	
	tabNames[#tabNames + 1] = sName
	termCoords[#termCoords + 1] = defaultTermSize
	tabsTerm[#tabsTerm + 1] = window.create(mainTerm,table.unpack(termCoords[#termCoords]))
	return #tabs
end

function runTab()
	local evnt = {}
	local tmp = ""
	while true do
		term.redirect(tabsTerm[currentTab])
		tmp = {coroutine.resume(tabs[currentTab],unpack(evnt))}
		if coroutine.status(tabs[currentTab]) == "dead" then
			table.remove(tabs,currentTab)
			table.remove(tabsTerm,currentTab)
			table.remove(tabNames,currentTab)
			break
		end
		local x , y = term.getCursorPos()
		local xSize , ySize = term.getSize()
		local orgBckColor = term.getBackgroundColor()
		local orgTxtColor = term.getTextColor()
		tabsTerm[currentTab].redraw()
		term.setCursorPos(xSize - 4,1)
		term.setBackgroundColor(colors.blue)
		term.setTextColor(colors.black)
		write("<")
		write(">")
		term.setBackgroundColor(colors.orange)
		term.setTextColor(colors.black)
		write("-")
		term.setBackgroundColor(colors.green)
		write("+")
		term.setBackgroundColor(colors.red)
		write("x")
		term.setBackgroundColor(orgBckColor)
		term.setTextColor(orgTxtColor)
		term.setCursorPos(x,y)
		evnt = {os.pullEvent(tmp[2])}
		--jos.showMessage(evnt[3].." "..evnt[4])
		if evnt[1] == "mouse_click" and evnt[3] == termCoords[currentTab][1] + xSize - 3 and evnt[4] == termCoords[currentTab][2] then
			break
		elseif evnt[1] == "mouse_click" and evnt[3] == termCoords[currentTab][1] + xSize -1 and evnt[4] == termCoords[currentTab][2] then
			table.remove(tabs,currentTab)
			table.remove(tabsTerm,currentTab)
			table.remove(tabNames,currentTab)
			break	
		elseif evnt[1] == "mouse_click" and evnt[3] ==  termCoords[currentTab][1] + xSize -2 and evnt[4] == termCoords[currentTab][2] then
			termCoords[currentTab] = {1,1,51,19}
			tabsTerm[currentTab].reposition(1,1,51,19)
		elseif evnt[1] == "mouse_click" and evnt[3] ==  termCoords[currentTab][1] + xSize -4 and evnt[4] == termCoords[currentTab][2] then			
			local i = currentTab
			i = i + 1 
			if i > #tabs then
				i = 1
			end
			currentTab = i
			term.redirect(mainTerm)
			jos.drawDesktopPicture(josCfg.desktopPictureDir)
			jos.loadDeskopFromFile(josCfg.desktopDirectory)
			
		elseif evnt[1] == "mouse_click" and evnt[3] ==  termCoords[currentTab][1] + xSize -5 and evnt[4] == termCoords[currentTab][2] then			
			local i = currentTab
			i = i - 1 
			if i < 1 then
				i = #tabs
			end
			currentTab = i
			term.redirect(mainTerm)
			jos.drawDesktopPicture(josCfg.desktopPictureDir)
			jos.loadDeskopFromFile(josCfg.desktopDirectory)
		end
			
	end
	term.redirect(mainTerm)
end

function changeCurrentTabI(i)
	if tonumber(i) > #tabs then
		i = #tabs
	end
	currentTab = i
end
function changeCurrentTabN(name)
	local ChangeToIndex = nil
	for i = 1,#tabs do
		if tabs[i] == name then
			changeToIndex = i 
		end
	end
	if ChangeToIndex == nil then
		print("no tab named "..name)
		sleep(1)
	else
		currentTab = changeToIndex
	end
end
function getTabLength()
	return #tabs
end
function getTabName(i)

	if i > #tabNames then
		i = #tabNames
	end
	return tabNames[i]
end
function getRunningTabs()
	return tabNames
end
